version: "3.9"
services:
  rethinkdb:
    image: rethinkdb:latest
    container_name: rethinkdb
    volumes:
      - ./rethinkdb-data:/data
    ports:
      - "8080:8080"
      - "28015:28015"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]  # RethinkDB web UI ready
      interval: 2s
      retries: 20
      start_period: 5s

  app:
    build:
      context: .
      args:
        REACT_APP_TITLE: ${REACT_APP_TITLE}
        REACT_APP_STORE_NAME: ${REACT_APP_STORE_NAME}
        REACT_APP_ROOT_IP_ADDRESS: ${REACT_APP_ROOT_IP_ADDRESS}
    image: gray9527/order-drink-app:latest
    container_name: order-drink-app
    environment:
      # 後端用
      - ROOT_IP_ADDRESS=${REACT_APP_ROOT_IP_ADDRESS}
      - RETHINKDB_HOST=${RETHINKDB_HOST}
      # 前端動態 env 用
      - REACT_APP_TITLE=${REACT_APP_TITLE}
      - REACT_APP_STORE_NAME=${REACT_APP_STORE_NAME}
      - REACT_APP_ROOT_IP_ADDRESS=${REACT_APP_ROOT_IP_ADDRESS}
    ports:
      - "5000:5000"
    depends_on:
      rethinkdb:
        condition: service_healthy
